---
title: "Benchmarking Office buildings"
author: "Pandarasamy Arjunan"
date: "3 June 2019"
output: 
  github_document:
    toc: true
    toc_depth: 3

#  html_document:
#    code_folding: "hide"
#    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(Metrics)
library(caret)
library(xgboost)
library(ggplot2)
library(reshape2)
library(ggpubr)
```

## Load dataset
```{r message=FALSE, warning=FALSE}
building_type = "office"

filtered_dir = './data/cbecs/filtered/'
dir.create(filtered_dir, recursive = T, showWarnings = F)

features_dir = './data/cbecs/features/'
dir.create(features_dir, recursive = T, showWarnings = F)

results_dir = './results/cbecs/'
dir.create(results_dir, recursive = T, showWarnings = F)

```

```{r}
cbecs = read.csv("data/cbecs/2012_public_use_data_aug2016.csv")

## list of building attributes relevant to office buildings 
columns = c( 'PBAPLUS', 'PBA', 'FINALWT', 
             'MFBTU', 'ELBTU', 'NGBTU', 'FKBTU', 'DHBTU',
             'ONEACT', 'ACT1', 'ACT2', 'ACT3', 'ACT1PCT', 'ACT2PCT', 'ACT3PCT',
             'PRAMTC', 'PRUNIT',
             'CWUSED', 'WOUSED', 'COUSED', 'SOUSED', 'PRUSED',
             'SQFT', 'NFLOOR', 'NELVTR', 'NESLTR', 'COURT', 
             'MONUSE', 'OPNWE',  'WKHRS', 'NWKER', 'COOK', 
             'MANU', 'HEATP',  'COOLP',  'SNACK', 'FASTFD', 'CAF',
             'FDPREP', 'KITCHN', 'BREAKRM', 'OTFDRM', 'LABEQP', 'MCHEQP',
             'POOL', 'HTPOOL', 'RFGWIN', 'RFGOPN', 'RFGCLN', 'RFGVNN',
             'RFGICN', 'PCTERMN', 'LAPTPN', 'PRNTRN', 'SERVERN', 'TVVIDEON',
             'RGSTRN', 'COPIERN', 'HDD65','CDD65')

offices = cbecs[, columns]
```

## Apply filters

As per Energy Star's technical document [ENERGY STAR Score for Offices](https://www.energystar.gov/buildings/tools-and-resources/energy-star-score-offices), following filters are applied to define the peer group and to remove any outliers.

After applying each filter, the number of remaining buildings in the dataset (_Number Remaining: X_) and any difference (_Difference: X_) in count from the original Energy Star's technical documentation is also given. 

#. **Calculate source energy and source EUI**
    ```{r}
## convert electricity, natural gas, fuel oil, and district heat to source energy
o0 = offices %>% 
  mutate(ELBTU0 = ELBTU*2.80) %>%
  mutate(NGBTU0 = NGBTU*1.05) %>%
  mutate(FKBTU0 = FKBTU*1.01) %>%
  mutate(DHBTU0 = DHBTU*1.20) %>%
  mutate(SOURCE_ENERGY = rowSums(dplyr::select(., c(ELBTU0,NGBTU0,FKBTU0,DHBTU0)), na.rm = T)) %>% 
  mutate(SOURCE_EUI = round(SOURCE_ENERGY/SQFT, 2)) %>%
  mutate(SITE_EUI = round(MFBTU/SQFT, 2)) %>%
  mutate(NGBTU_PERCENT = round(NGBTU / SOURCE_ENERGY * 100, 2)) %>% 
  mutate(SUMBTU = rowSums(dplyr::select(., c(ELBTU,NGBTU,FKBTU,DHBTU)), na.rm = T))

#Is MFBTU the sum of ELBTU,NGBTU,FKBTU,DHBTU? YES.
#summary(o14$MFBTU - o14$SUMBTU)

    ```

#. **PBAPLUS = 2, 3, 4 or 52**
<br/>Building Type Filter – CBECS defines building types according to the variable “PBAPLUS.” Offices are coded as PBAPLUS=2 and 4; Bank/Financial Institutions are coded as PBAPLUS=3; and Courthouses are coded as PBAPLUS=52.
<br/>Number Remaining: 1076.
<br/>Difference: 0.
    ```{r}
o1 = o0 %>% filter(PBAPLUS %in% c(2, 3, 4, 52))
    ```

#. **Must have at least 1 computer**
<br/>EPA Program Filter – Baseline condition for being a functioning office building.
<br/>Number Remaining: 1072.
<br/>Difference: 0.
    ```{r}
    o2 = o1 %>% 
      mutate(PC_TOT = 
               rowSums(dplyr::select(., c(PCTERMN,SERVERN,LAPTPN)), na.rm = T)) %>% 
      filter(PC_TOT >= 1)
    ```

#. **Must have at least 1 worker**
<br/>EPA Program Filter – Baseline condition for being a full time office building.
<br/>Number Remaining: 1072.
<br/>Difference: 0.
    ```{r}
    o3 = o2 %>% filter(NWKER >= 1)
    ```


#. **Must operate for at least 30 hours per week**
<br/>EPA Program Filter – Baseline condition for being a full time office building.
<br/>Number Remaining: 1065.
<br/>Difference: 0.
    ```{r}
    o4 = o3 %>% filter(WKHRS >= 30)
    ```
#. **Must operate for at least 10 months per year**
<br/>EPA Program Filter – Baseline condition for being a full time office building.
<br/>Number Remaining: 1046.
<br/>Difference: 0.
    ```{r}
    o5 = o4 %>% filter(MONUSE >= 10)
    ```
#. **A single activity must characterize greater than 50% of the floor space**
<br/>EPA Program Filter – In order to be considered part of the office peer group, more than 50% of the building must be defined as an office, bank/financial institution, or courthouse.
<br/>This filter is applied by a set of screens. If the variable ONEACT=1, then one activity occupies 75% or more of the building. If the variable ONEACT=2, then the activities in the building are defined by ACT1, ACT2, and ACT3. One of these activities must be coded as Office/Professional (PBAX=11) or Public Order and Safety (PBAX=23), with a corresponding percent (ACT1PCT, ACT2PCT, ACT3PCT) that is greater than 50.
<br/>Number Remaining: 1003.
<br/>Difference: 0.
    ```{r}
    o6 = o5 %>% 
      filter( (ONEACT == 1) |
              (ONEACT == 2 & 
               ((ACT1 %in% c(11,23) & ACT1PCT > 50) | 
                  (ACT2 %in% c(11,23) & ACT2PCT > 50) | 
                  (ACT3 %in% c(11,23) & ACT3PCT > 50) )))
    ```
#. **Must report energy usage**
<br/>EPA Program Filter – Baseline condition for being a full time office building.
<br/>Number Remaining: 1003.
<br/>Difference: 0.
    ```{r}
    o7 = o6 %>% filter(!is.na(MFBTU))
    ```

#. **Must be less than or equal to 1,000,000 square feet**
<br/>Data Limitation Filter – CBECS masks surveyed properties above 1,000,000 square feet by applying regional averages.
<br/>Number Remaining: 972.
<br/>Difference: 0.
    ```{r}
    o8 = o7 %>% filter(SQFT <= 1000000)
    ```

#. **If propane is used, the amount category (PRAMTC) must equal 1, 2, or 3**
<br/>Data Limitation Filter – Cannot estimate propane use if the quantity is “greater than 1000” or unknown.
<br/>Number Remaining: 959.
<br/>Difference: 0.
    ```{r}
    o9 = o8 %>% filter(is.na(PRAMTC) | PRAMTC %in% c(1,2,3))
    ```


#. **If propane is used, the unit (PRUNIT) must be known**
<br/>Data Limitation Filter – Cannot estimate propane use if the unit is unknown.
<br/>Number Remaining: 959.
<br/>Difference: 0.
    ```{r}
    o10 = o9 %>% filter(is.na(PRUNIT) | PRUNIT %in% c(1,2))
    ```

#. **If propane is used, the maximum estimated propane amount must be 10% or less of the total source energy**
<br/>Data Limitation Filter – Because propane values are estimated from a range, propane is restricted to 10% of the total source energy.
<br/>Number Remaining: 957.
<br/>Difference: 0.
    ```{r}
    o11 = o10 %>% 
      filter( PRUSED == 2 | is.na(NGBTU_PERCENT) == T | 
            ( PRUSED == 1 & NGBTU_PERCENT <= 10))
    ```

#. **must not use chilled water, wood, coal, or solar**
<br/>Data Limitation Filter – CBECS does not collect quantities of chilled water, wood, coal, or solar.
<br/>Number Remaining: 897. 
<br/>Difference: +1.
    ```{r}
    o12 = o11 %>% 
      filter(CWUSED == 2 & WOUSED == 2 & COUSED == 2 & SOUSED == 2)
    ```

#. **Server count must be known**
<br/>Data Limitation Filter – CBECS codes missing responses for number of servers as ‘9995.’
<br/>Number Remaining: 893.
<br/>Difference: +1.
    ```{r}
    o13 = o12 %>% filter(SERVERN != 9995)
    ```

#. **Must have no more than 8 workers per 1,000 square feet**
<br/>Analytical Filter – Values determined to be statistical outliers.
<br/>Number Remaining: 889. 
<br/>Difference: +1.
    ```{r}
    o14 = o13 %>% filter(NWKER  / SQFT * 1000 <= 8)
    ```

#. **Banks must have Source EUI greater than 50 kBtu/ft2**
<br/>Analytical Filter – Values determined to be statistical outliers.
<br/>Number Remaining: 887.
<br/>Difference: +1.
    ```{r}
    o15 = o14 %>% 
      filter( PBAPLUS != 3 | (PBAPLUS == 3 & SOURCE_EUI > 50))
    ```

**Save the filtered dataset**
```{r}
write.csv(o15, paste0(filtered_dir, building_type, ".csv"), row.names = F)
```


## Prepare features

The final regression equation includes the following variables: 

 - Square Footage
 - Weekly Operating Hours
 - Number of Workers per 1,000 Square Feet
 - Number of Computers per 1,000 Square Feet
 - Natural log of Cooling Degree Days times Percent of the Building that is Cooled
 - Whether or not the Building is a Bank Branch (1 = yes, 0 = no)


```{r}
office = read.csv(paste0(filtered_dir, building_type, ".csv"))

data = office %>%
  mutate(NWKER_SQFT = NWKER/SQFT * 1000) %>%
  mutate(PCTERMN_TOT = rowSums(dplyr::select(., c(PCTERMN,SERVERN,LAPTPN)), na.rm = T)) %>% 
  mutate(PCTERMN_SQFT = PCTERMN_TOT/SQFT * 1000) %>%
  mutate(CDD65_COOLP = log(CDD65) * COOLP / 100) %>%
  mutate(IsBank = ifelse(PBAPLUS == 3, "Yes", "No")) %>%
  mutate_if(is.numeric, round, 3)

#data = data %>% filter(SOURCE_EUI <= 500)

ivars = c("SQFT", "WKHRS", "NWKER_SQFT", "PCTERMN_SQFT", 
          "CDD65_COOLP", "IsBank")
dvars  = c("SOURCE_EUI", "SOURCE_ENERGY", "FINALWT")

features = data[, c(ivars, dvars)]
features = features %>% na.omit()

write.csv(features, 
          paste0(features_dir, building_type, ".csv"), 
          row.names = F)
```


## Descriptive statistics 
```{r include=FALSE}
library(knitr)
opts_chunk$set(results = 'asis',      
              comment = NA, 
              prompt = FALSE, 
              cache = FALSE)

library(summarytools)
st_options(plain.ascii = FALSE,       
            style = "rmarkdown",      
            footnote = NA,            
            subtitle.emphasis = FALSE)                                    
st_css()                              
```

```{r}
features1 = features

## summary of SQFT less than 100,000 only, as per Energy Star tech doc.
features1[features1$SQFT >= 100000, ]$SQFT = NA
features1 = features1 %>% dplyr::select(-one_of('SOURCE_ENERGY', 'FINALWT'))

summarytools::descr(features1, stats = "common", 
                    transpose = TRUE, 
                    headings = FALSE)
```


```{r}
dfSummary(features1, plain.ascii = FALSE, style = "grid", 
          graph.magnif = 0.75, valid.col = FALSE)
```


**Extract R code from Rmd document**
```{r}
#knitr::purl("office.Rmd", output = "office.R", documentation = 2)
```

## Build predictive models

```{r}
source("models.R")
source("metrics.R")

data = read.csv(paste0(features_dir, building_type, ".csv"))

cat(colnames(data))

allMetrics = NULL

```


### Multiple Linear Regression (MLR)

#### Using SOURCE_EUI as dependent variable
```{r}
y = "SOURCE_EUI"
w = "FINALWT"
o = c("SOURCE_ENERGY", "SQFT")
x = setdiff(colnames(data), c(y, w, o))
wt = data[, w]
intr = 1

mlrFit = MLR(data, x, y, w, interaction = intr)

obs  = data[, y]
pred = as.numeric(predict(mlrFit))

mlrMetrics1 = getMLRmetrics(mlrFit, obs, pred, wt)
mlrMetrics1 = data.frame(
  "model" = "MLR",
  "dependent" = y,
  "interaction" = intr,
  "transform" = "meanCent",
  mlrMetrics1)

allMetrics = rbind(allMetrics, mlrMetrics1)

knitr::kable(mlrMetrics1, row.names = F)

```

#### Using SOURCE_ENERGY as dependent variable**
```{r}
y = "SOURCE_ENERGY"
w = "FINALWT"
o = c("SOURCE_EUI")
x = setdiff(colnames(data), c(y, w, o))
wt = data[, w]
intr = 1

mlrFit = MLR(data, x, y, w, interaction = intr)

obs  = data[, y]
pred = as.numeric(predict(mlrFit))

mlrMetrics2 = getMLRmetrics(mlrFit, obs, pred, wt)
mlrMetrics2 = data.frame(
  "model" = "MLR",
  "dependent" = y,
  "interaction" = intr,
  "transform" = "meanCent",
  mlrMetrics2)
allMetrics = rbind(allMetrics, mlrMetrics2)
knitr::kable(allMetrics, row.names = F)

```



### Multiple Linear Regression (MLR) with Interaction terms

#### Using SOURCE_EUI as dependent variable
```{r}
y = "SOURCE_EUI"
w = "FINALWT"
o = c("SOURCE_ENERGY", "SQFT")
x = setdiff(colnames(data), c(y, w, o))
wt = data[, w]

intr_depth = length(x)

for (intr in 2:intr_depth) {
  
  mlrFit = MLR(data, x, y, w, interaction = intr)
  obs  = data[, y]
  pred = as.numeric(predict(mlrFit))
  
  mlrMetrics = getMLRmetrics(mlrFit, obs, pred, wt)
  mlrMetrics = data.frame(
    "model" = paste0("MLRi", intr),
    "dependent" = y,
    "interaction" = intr,
    "transform" = "meanCent",
    mlrMetrics)
  
  allMetrics = rbind(allMetrics, mlrMetrics)
}

allMetrics0 = allMetrics %>% filter(dependent == y)
knitr::kable(allMetrics0, row.names = F)

```

#### Using SOURCE_ENERGY as dependent variable**
```{r}
y = "SOURCE_ENERGY"
w = "FINALWT"
o = c("SOURCE_EUI")
x = setdiff(colnames(data), c(y, w, o))
wt = data[, w]
intr_depth = length(x)

for (intr in 2:intr_depth) {
  
  mlrFit = MLR(data, x, y, w, interaction = intr)
  obs  = data[, y]
  pred = as.numeric(predict(mlrFit))
  
  mlrMetrics = getMLRmetrics(mlrFit, obs, pred, wt)
  mlrMetrics = data.frame(
    "model" = paste0("MLRi", intr),
    "dependent" = y,
    "interaction" = intr,
    "transform" = "meanCent",
    mlrMetrics)
  
  allMetrics = rbind(allMetrics, mlrMetrics)
}

write.csv(allMetrics, 
          paste0(results_dir, building_type, ".csv"), 
          row.names = F)

allMetrics0 = allMetrics %>% filter(dependent == y)
knitr::kable(allMetrics0, row.names = F)

```


### Comparision of MLR models

#### MLR plots using Source EUI
```{r, warning=FALSE}
mytheme = theme(legend.title = element_blank(),
           legend.text=element_text(size=12),
           axis.text=element_text(size=12),
           text=element_text(size=12))

plotR2 <- function(df, titl) {
  
  df1 = melt(df, measure.vars = c("R.2", "Adj.R.2"))
  
  plot <- ggplot(df1, aes(x = interaction, y=value, 
                          group=variable, col=variable)) + 
  geom_point(size=2) + geom_line(size=1) +
    ggtitle(titl) + 
    theme_pubr(base_size=12) +
    theme(legend.position="top", legend.title = element_blank())
  
  return(plot)
}

plotNRMSE <- function(df, titl) {
  
  df1 = melt(df, measure.vars = c("nrmse_iqr", "nrmse_mean", 
                                        "nrmse_sd"))
  df1$variable = toupper(df1$variable)
  
  plot <- ggplot(df1, aes(x = interaction, y=value, 
                          group=variable, col=variable)) + 
  geom_point(size=2) + geom_line(size=1) +
    ggtitle(titl) + 
    theme_pubr(base_size=12) +
    theme(legend.position="top", legend.title = element_blank())
    
  
  return(plot)
}  

```

```{r}

allMetrics0 = allMetrics %>%
  filter(stringr::str_detect(model, "MLR")) %>%
  filter(dependent == "SOURCE_EUI")

plot1 = plotR2(allMetrics0, "MLR models using source EUI")
plot2 = plotNRMSE(allMetrics0, "MLR models using source EUI")

print(plot1)
print(plot2)

```


#### MLR plots using Source Energy
```{r}

allMetrics0 = allMetrics %>%
  filter(stringr::str_detect(model, "MLR")) %>%
  filter(dependent == "SOURCE_ENERGY")

plot1 = plotR2(allMetrics0, "MLR models using source energy")
plot2 = plotNRMSE(allMetrics0, "MLR models using source energy")

print(plot1)
print(plot2)

```
